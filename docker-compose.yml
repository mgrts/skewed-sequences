# docker-compose.yml — scale experiment workers across machines
#
# Usage:
#   docker compose up                          # run all services
#   docker compose up --scale worker=4         # 4 parallel workers
#   docker compose run worker skseq train ...  # ad-hoc single run
#
# Mount local data/mlruns/models so results persist on the host.

services:
  # MLflow tracking server (optional, for centralized logging)
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.19.0
    ports:
      - "5000:5000"
    volumes:
      - ./mlruns:/mlflow/mlruns
    command: >
      mlflow server
        --host 0.0.0.0
        --port 5000
        --backend-store-uri file:///mlflow/mlruns
        --default-artifact-root file:///mlflow/mlruns
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Experiment worker — the main skewed-sequences image
  worker:
    build: .
    volumes:
      - ./data:/app/data
      - ./mlruns:/app/mlruns
      - ./models:/app/models
      - ./reports:/app/reports
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    depends_on:
      mlflow:
        condition: service_healthy
    # Override CMD per-run, e.g.:
    #   docker compose run worker skseq experiments run-synthetic
    entrypoint: ["skseq"]
    command: ["--help"]
